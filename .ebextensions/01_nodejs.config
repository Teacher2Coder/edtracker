option_settings:
  aws:elasticbeanstalk:application:environment:
    NODE_ENV: production
    NPM_USE_PRODUCTION: false
    SKIP_SEEDING: true
  aws:elasticbeanstalk:command:
    Timeout: 2400
  aws:elasticbeanstalk:container:nodejs:
    NodeCommand: "node server/server.js"
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.micro
    SecurityGroups: default

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_install_deps.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/ondeck
      
      echo "Installing root dependencies..."
      npm install --production || { echo "Root npm install failed"; exit 1; }
      
      echo "Installing server dependencies..."
      cd server && npm install --production || { echo "Server npm install failed"; exit 1; }
      
      echo "Installing client dependencies..."
      cd ../client && npm install || { echo "Client npm install failed"; exit 1; }
      
      echo "Building client..."
      npm run build || { echo "Client build failed"; exit 1; }
      
      echo "Verifying build..."
      ls -la dist/ || echo "No dist directory found"
      
      echo "Cleaning up client node_modules..."
      rm -rf node_modules
      
      echo "All deployment steps completed successfully!" 